{"version":3,"sources":["common/environment.ts","common/apollo/client.js","importer/mutations/createUserWithDashboard.ts","importer/queries/getUserIds.ts","importer/ensure-initial-data.ts","resolvers/Query/getMarkets.ts","resolvers/Query/index.ts","resolvers/index.ts","index.ts"],"names":["isBrowser","Boolean","window","isServer","isDevelopment","process","env","NODE_ENV","isProduction","dotenv","config","API_HOST","API_PORT","getApolloClient","options","server","cache","InMemoryCache","uri","restore","__APOLLO_STATE__","link","HttpLink","fetch","client","ApolloClient","ssrMode","createUserWithDashboard","gql","getUserIds","PRISMA_HOST","PRISMA_PORT","ensureInitialData","console","log","apolloClient","usersResult","query","usersExist","data","users","length","createUserWithDashboardResult","mutate","mutation","variables","name","MARKETSTORE_API_HOST","MARKETSTORE_API_PORT","quote","_parent","_args","_context","_info","host","port","url","fetchResult","fetchResultText","text","fetchResultJSON","JSON","parse","output","map","base","getMarkets","Query","API_PORT_IN","Number","String","resolvers","resolversModule","typeDefs","context","req","prisma","Prisma","endpoint","debug","apolloServer","ApolloServer","main","listen","error"],"mappings":"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","file":"index.js","sourceRoot":"../src","sourcesContent":["export function isBrowser() {\n  return Boolean(typeof window !== 'undefined')\n}\n\nexport function isServer() {\n  return Boolean(typeof window === 'undefined')\n}\n\nexport function isDevelopment() {\n  return Boolean(process.env.NODE_ENV === 'develop')\n}\n\nexport function isProduction() {\n  return Boolean(process.env.NODE_ENV === 'production')\n}\n","import dotenv from 'dotenv'\nimport fetch from 'cross-fetch'\nimport { memoize } from 'lodash'\n\nimport ApolloClient from 'apollo-client'\nimport { HttpLink } from 'apollo-link-http'\nimport { InMemoryCache } from 'apollo-cache-inmemory'\n\nimport { isServer } from '../environment'\n\ndotenv.config()\n\nconst { API_HOST, API_PORT } = process.env\n\nexport const getApolloClient = memoize((options = {}) => {\n  const server = isServer()\n  const cache = options.cache || new InMemoryCache()\n  const uri = options.uri || (server && `http://${API_HOST}:${API_PORT}/`) || `http://api.localtest.me`\n\n  if (!server) {\n    // eslint-disable-next-line no-underscore-dangle\n    cache.restore(window.__APOLLO_STATE__)\n  }\n\n  const link = options.link || new HttpLink({ uri, fetch })\n\n  const client = new ApolloClient({\n    cache,\n    link,\n    ssrMode: isServer(),\n  })\n\n  return client\n})\n","import gql from 'graphql-tag'\n\nexport const createUserWithDashboard = gql`\n  mutation createUserWithDashboard($name: String!) {\n    createUser(data: { name: $name, dashboard: { create: {} } }) {\n      id\n      name\n      dashboard {\n        id\n      }\n    }\n  }\n`\n","import gql from 'graphql-tag'\n\nexport const getUserIds = gql`\n  query {\n    users {\n      id\n    }\n  }\n`\n","import dotenv from 'dotenv'\nimport { getApolloClient } from '../common/apollo/client'\nimport { createUserWithDashboard } from './mutations/createUserWithDashboard'\nimport { getUserIds } from './queries/getUserIds'\n\ndotenv.config()\n\nconst { PRISMA_HOST, PRISMA_PORT } = process.env\n\nexport async function ensureInitialData() {\n  console.log('ensureInitialData')\n\n  const apolloClient = getApolloClient({\n    uri: `http://${PRISMA_HOST}:${PRISMA_PORT}`,\n  })\n\n  const usersResult = await apolloClient.query({ query: getUserIds })\n  const usersExist = usersResult?.data?.users?.length > 0\n\n  if (usersExist) {\n    // console.log('ensureInitialData users exist, removing charts')\n    // await apolloClient.mutate({ mutation: deleteManyCharts })\n    // console.log('ensureInitialData charts removed')\n  } else {\n    console.log('ensureInitialData creating new users')\n\n    const createUserWithDashboardResult = await apolloClient.mutate({\n      mutation: createUserWithDashboard,\n      variables: {\n        name: 'admin',\n      },\n    })\n\n    console.log('ensureInitialData createUserWithDashboardResult', createUserWithDashboardResult)\n  }\n\n  console.log('ensureInitialData done')\n}\n","const { MARKETSTORE_API_HOST, MARKETSTORE_API_PORT } = process.env\n\n// TODO: Get from somewhere.\nconst quote = 'BTC'\n\nexport default async (_parent: any, _args: any, _context: any, _info: any) => {\n  const host = MARKETSTORE_API_HOST\n  const port = MARKETSTORE_API_PORT\n  const url = `http://${host}:${port}/markets`\n\n  const fetchResult = await fetch(url)\n  // console.log('getMarkets fetchResult', fetchResult)\n\n  const fetchResultText = await fetchResult.text()\n  // console.log(`getMarkets fetchResultText \"${fetchResultText}\"`, typeof fetchResultText)\n\n  const fetchResultJSON = JSON.parse(fetchResultText)\n  // console.log('getMarkets fetchResultJSON', fetchResultJSON)\n\n  const output = fetchResultJSON.map((base: string) => {\n    return {\n      base,\n      quote,\n    }\n  })\n  // console.log('getMarkets output', output)\n\n  return output\n}\n","// import getChartById from './getChartById'\n// import getCurrentUser from './getCurrentUser'\n// import getDashboard from './getDashboard'\nimport getMarkets from './getMarkets'\n// import getOHLCVs from './getOHLCVs'\n\nexport default {\n  // getChartById,\n  // getCurrentUser,\n  // getDashboard,\n  getMarkets,\n  // getOHLCVs,\n}\n","// import Chart from './Chart'\n// import Mutation from './Mutation'\n// import Market from './Market'\nimport Query from './Query'\n\nexport default {\n  // Chart,\n  // Mutation,\n  // Market,\n  Query\n}\n","import { ApolloServer } from 'apollo-server'\nimport { ContextFunction } from 'apollo-server-core'\nimport dotenv from 'dotenv'\nimport { importSchema } from 'graphql-import'\nimport { Prisma } from 'prisma-binding'\nimport { ensureInitialData } from './importer/ensure-initial-data'\nimport resolversModule from './resolvers'\n\ndotenv.config()\n\nconst API_PORT_IN = Number(process.env.API_PORT_IN)\nconst PRISMA_HOST = String(process.env.PRISMA_HOST)\nconst PRISMA_PORT = Number(process.env.PRISMA_PORT)\n\n// Type Checked Resolvers.\nconst resolvers = resolversModule\n\nconst typeDefs = importSchema('./src/datamodel.graphql')\n\nconst context: ContextFunction = (req) => {\n  return {\n    ...req,\n    prisma: new Prisma({\n      typeDefs: 'src/datamodel.prisma.gen.graphql',\n      endpoint: `http://${PRISMA_HOST}:${PRISMA_PORT}`,\n      debug: true,\n    }),\n  }\n}\n\nconst apolloServer = new ApolloServer({\n  typeDefs,\n  resolvers,\n  context,\n})\n\nconst main = async () => {\n  try {\n    console.log('main')\n    console.log('main:API_PORT_IN', API_PORT_IN)\n    console.log('main:PRISMA_HOST', PRISMA_HOST)\n    console.log('main:PRISMA_PORT', PRISMA_PORT)\n\n    const { url } = await apolloServer.listen({\n      port: API_PORT_IN,\n    })\n\n    console.log(`GraphQL server is running on ${url}`)\n\n    await ensureInitialData()\n\n    console.log(`Seeded initial data`)\n  } catch (error) {\n    console.error(error)\n  }\n}\n\nmain()\n"]}